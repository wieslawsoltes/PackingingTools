using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Text.Json;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using PackagingTools.Core.Abstractions;
using PackagingTools.Core.Models;

namespace PackagingTools.Core.Security.Vulnerability.Scanners;

public sealed class TrivyVulnerabilityScanner : IVulnerabilityScanner
{
    private readonly ILogger<TrivyVulnerabilityScanner>? _logger;

    public TrivyVulnerabilityScanner(ILogger<TrivyVulnerabilityScanner>? logger = null)
    {
        _logger = logger;
    }

    public string Name => "trivy";

    public async Task<VulnerabilityScanResult> ScanAsync(PackageFormatContext context, PackagingArtifact artifact, CancellationToken cancellationToken = default)
    {
        if (!OperatingSystem.IsLinux())
        {
            return new VulnerabilityScanResult(Array.Empty<VulnerabilityFinding>(), null);
        }

        var processStart = new ProcessStartInfo("trivy")
        {
            ArgumentList = { "fs", "--format", "json", artifact.Path },
            RedirectStandardOutput = true,
            RedirectStandardError = true
        };

        try
        {
            using var process = Process.Start(processStart);
            if (process is null)
            {
                throw new InvalidOperationException("Failed to start trivy process.");
            }

            var output = await process.StandardOutput.ReadToEndAsync(cancellationToken).ConfigureAwait(false);
            var stderr = await process.StandardError.ReadToEndAsync(cancellationToken).ConfigureAwait(false);
            await process.WaitForExitAsync(cancellationToken).ConfigureAwait(false);

            if (process.ExitCode != 0)
            {
                _logger?.LogWarning("Trivy exited with code {Code}: {Error}", process.ExitCode, stderr);
                var issue = new PackagingIssue(
                    "security.vuln.trivy_failed",
                    $"Trivy scan failed for '{artifact.Path}': {stderr}",
                    PackagingIssueSeverity.Warning);
                return new VulnerabilityScanResult(Array.Empty<VulnerabilityFinding>(), issue);
            }

            var findings = ParseFindings(output);
            return new VulnerabilityScanResult(findings, null);
        }
        catch (Exception ex)
        {
            _logger?.LogWarning(ex, "Trivy scan threw an exception");
            var issue = new PackagingIssue(
                "security.vuln.trivy_exception",
                $"Trivy scan failed: {ex.Message}",
                PackagingIssueSeverity.Warning);
            return new VulnerabilityScanResult(Array.Empty<VulnerabilityFinding>(), issue);
        }
    }

    private static VulnerabilityFinding[] ParseFindings(string json)
    {
        if (string.IsNullOrWhiteSpace(json))
        {
            return Array.Empty<VulnerabilityFinding>();
        }

        try
        {
            using var document = JsonDocument.Parse(json);
            if (!document.RootElement.TryGetProperty("Results", out var results))
            {
                return Array.Empty<VulnerabilityFinding>();
            }

            var findings = new List<VulnerabilityFinding>();
            foreach (var result in results.EnumerateArray())
            {
                if (!result.TryGetProperty("Vulnerabilities", out var vulnerabilities))
                {
                    continue;
                }

                foreach (var vuln in vulnerabilities.EnumerateArray())
                {
                    var id = vuln.TryGetProperty("VulnerabilityID", out var idElement) ? idElement.GetString() ?? string.Empty : string.Empty;
                    var severity = vuln.TryGetProperty("Severity", out var severityElement) ? severityElement.GetString() ?? string.Empty : string.Empty;
                    var title = vuln.TryGetProperty("Title", out var titleElement) ? titleElement.GetString() ?? string.Empty : string.Empty;
                    var url = vuln.TryGetProperty("PrimaryURL", out var urlElement) ? urlElement.GetString() : null;

                    if (string.IsNullOrWhiteSpace(id))
                    {
                        continue;
                    }

                    findings.Add(new VulnerabilityFinding(id, severity, title, url));
                }
            }

            return findings.ToArray();
        }
        catch (JsonException)
        {
            return Array.Empty<VulnerabilityFinding>();
        }
    }
}
